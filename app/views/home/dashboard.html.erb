<button id="push-notification">Push</button>

<div id="dashboard-header">
  <p id="dashboard-header-title">
    Manage Your Projects
  </p>
</div>

<div class="container">

  <%= link_to 'New Project', new_project_path, id: 'dashboard-new-project' %>

  <br />

  <div class="row">
    <div class="col-md-6 ml-auto mr-auto">

      <div class="row">
        <div class="col-8 ml-auto mr-auto">

          <h4 class="text-center">Your Projects</h4>

          <ul class="list-group">
            <% @accepted_projects.each do |proj| %>
              <%= link_to proj.title, project_path(proj), class: "list-group-item list-group-item-action" %>
            <% end %>
          </ul>

        </div>
      </div>

    </div>

    <div class="col-md-6 ml-auto mr-auto">

      <div class="row">
        <div class="col-8 ml-auto mr-auto">

          <h4 class="text-center">Pending Invitations</h4>

          <ul class="list-group">
            <% @pending_projects.each do |proj| %>
              <li class="list-group-item">
                <%= proj.title %>
                <%= link_to 'Accept Invitation', accept_project_invitation_path(proj_id: proj.id), class: 'btn btn-xs btn-success' %>
              </li>
            <% end %>
          </ul>

        </div>
      </div>

    </div>
  </div>
</div>


<script type="text/javascript">
  $(document).ready( () => {
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', function() {
        navigator.serviceWorker.register('/serviceworker.js', { scope: './' }).then(function(registration) {
          // Registration was successful
          console.log('ServiceWorker registration successful with scope: ', registration.scope);

          registration.pushManager.getSubscription().then( function(subscription) {
              isSubscribed = !(subscription === null);

              if (isSubscribed) {
                console.log('User IS subscribed.');
              } else {
                console.log('User is NOT subscribed.');
                subscribeUser(registration, <%= current_user.id %>);
              }
          });

        }, function(err) {
          // registration failed :(
          console.log('ServiceWorker registration failed: ', err);
        });
      });
    }

    $('#push-notification').click( () => {
      const url = 'workers/push/<%= current_user.id %>'
      fetch(url);
    })
  })
</script>
